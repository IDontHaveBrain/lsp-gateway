# TypeScript E2E Test Configuration
# Optimized for testing TypeScript LSP features with Microsoft TypeScript repository
# Supports: definition, references, hover, document symbols, workspace symbols, completion

# Gateway configuration for test scenarios
port: ${TEST_PORT:-8080}
timeout: "30s"
max_concurrent_requests: 40
project_aware: true
enable_concurrent_servers: false
max_concurrent_servers_per_language: 2

# Test project context for Microsoft TypeScript repository
project_context:
  project_type: "single-language"
  root_directory: "${workspaceFolder}"
  languages:
    - language: "typescript"
      frameworks: ["typescript", "compiler", "language-server"]
      file_patterns: ["*.ts", "*.tsx", "*.js", "*.jsx"]
      root_markers: ["tsconfig.json", "package.json", "*.ts"]

# TypeScript language server pool optimized for testing
language_pools:
  - language: "typescript"
    default_server: "typescript-language-server-test"
    servers:
      # Primary test server with essential features
      typescript-language-server-test:
        name: "typescript-language-server-test"
        languages: ["typescript", "javascript"]
        command: "typescript-language-server"
        args: ["--stdio"]
        transport: "stdio"
        priority: 3
        weight: 3.0
        max_concurrent_requests: 25
        root_markers: ["tsconfig.json", "package.json"]
        
        # Test-optimized TypeScript language server configuration
        settings:
          typescript:
            preferences:
              # Core LSP features for testing
              includeCompletionsForModuleExports: true
              includeCompletionsWithInsertText: true
              allowTextChangesInNewFiles: true
              includeCompletionsForImportStatements: true
              includeCompletionsWithClassMemberSnippets: true
              
            suggest:
              # Completion settings
              enabled: true
              includeAutomaticOptionalChainCompletions: true
              includeCompletionsWithSnippetText: true
              includeCompletionsWithClassMemberSnippets: true
              
            # Diagnostics settings for test stability
            diagnostics:
              ignoredCodes: [6133, 6138, 7016, 7006, 2307, 7009]  # Relaxed for test examples
              
            # IntelliSense settings
            intelliSense:
              includeAutomaticOptionalChainCompletions: true
              
            # Compiler options for testing
            compile:
              onSave: false
              noImplicitAny: false
              strictNullChecks: false
              
          javascript:
            preferences:
              includeCompletionsForModuleExports: true
              includeCompletionsWithInsertText: true
              allowTextChangesInNewFiles: true
              
            suggest:
              enabled: true
              includeAutomaticOptionalChainCompletions: true
              includeCompletionsWithSnippetText: true
              
        # Test environment
        environment:
          NODE_PATH: "${workspaceFolder}/node_modules:${NODE_PATH:-}"
          TS_NODE_PROJECT: "tsconfig.json"
          TYPESCRIPT_SERVICE_PLUGIN_PATH: "${workspaceFolder}/lib"
          
      # Fallback server for error scenarios
      typescript-language-server-fallback:
        name: "typescript-language-server-fallback"
        languages: ["typescript", "javascript"]
        command: "typescript-language-server"
        args: ["--stdio"]
        transport: "stdio"
        priority: 1
        weight: 1.0
        max_concurrent_requests: 15
        root_markers: ["tsconfig.json"]
        
        # Minimal configuration for fallback
        settings:
          typescript:
            preferences:
              includeCompletionsForModuleExports: true
            suggest:
              enabled: true
              
        environment:
          NODE_PATH: "${workspaceFolder}/node_modules"
          
    # Load balancing for test scenarios
    load_balancing:
      strategy: "round_robin"
      health_threshold: 0.70
      weight_factors:
        typescript-language-server-test: 3.0
        typescript-language-server-fallback: 1.0
        
    # Resource limits for test environment
    resource_limits:
      max_memory_mb: 1536
      max_concurrent_requests: 40
      max_processes: 3
      request_timeout_seconds: 45

# Enhanced pool configuration for TypeScript test servers
servers:
  - name: "typescript-compiler-test-pool"
    languages: ["typescript", "javascript"]
    command: "typescript-language-server"
    args: ["--stdio"]
    transport: "stdio"
    root_markers: ["tsconfig.json", "package.json"]
    
    # Pool configuration optimized for testing
    pool_config:
      min_size: 1
      max_size: 3
      warmup_size: 1
      
      # Conservative scaling for test stability
      enable_dynamic_sizing: false
      
      # Test-appropriate lifecycle
      max_lifetime: 20m
      idle_timeout: 7m
      health_check_interval: 30s
      
      # Retry configuration for test reliability
      max_retries: 3
      base_delay: 150ms
      circuit_timeout: 20s
      
      # Memory limits for test environment
      memory_limit_mb: 768
      cpu_limit_percent: 60.0
      
      transport_type: "stdio"
      custom_config:
        process_isolation: true
        node_modules_support: true
        typescript_support: true
        test_mode: true
        
    # Health monitoring for test stability
    health_check_settings:
      enabled: true
      interval: 30s
      timeout: 6s
      failure_threshold: 2
      success_threshold: 1
      method: "ping"
      enable_auto_restart: true
      restart_delay: 7s
      max_consecutive_fails: 2
      
    # Test environment
    environment:
      NODE_PATH: "${workspaceFolder}/node_modules:${NODE_PATH:-}"
      TS_NODE_PROJECT: "tsconfig.json"
      TYPESCRIPT_SERVICE_PLUGIN_PATH: "${workspaceFolder}/lib"

# Smart routing optimized for test scenarios
enable_smart_routing: true
enable_enhancements: false
smart_router_config:
  default_strategy: "single_target_with_fallback"
  method_strategies:
    "textDocument/definition": "single_target_with_fallback"
    "textDocument/references": "single_target_with_fallback"
    "textDocument/hover": "single_target_with_fallback"
    "textDocument/completion": "single_target_with_fallback"
    "textDocument/documentSymbol": "single_target_with_fallback"
    "workspace/symbol": "single_target_with_fallback"
  enable_performance_monitoring: true
  enable_circuit_breaker: true
  circuit_breaker_threshold: 3
  circuit_breaker_timeout: "20s"

# Test-specific optimizations
optimizations:
  typescript:
    # Node modules handling
    node_modules:
      auto_detect: true
      include_types: true
      
    # TypeScript project structure
    project_structure:
      source_directory: "src"
      test_directory: "tests"
      types_directory: "lib"
      built_directory: "built"
      
    # Package management for tests
    package_managers:
      - name: "npm"
        enabled: true
        
    # Code quality tools disabled for test performance
    linting: []
    
    # Testing frameworks (minimal)
    testing:
      - name: "typescript-compiler"
        enabled: true

# Test repository configurations for TypeScript projects
test_repositories:
  # Main TypeScript repository
  typescript:
    repo_url: "https://github.com/microsoft/TypeScript.git"
    workspace_path: "${TEST_WORKSPACE}/TypeScript"
    source_dir: "src"
    test_files_pattern: "src/**/*.ts"
    version_tag: "${VERSION_TAG:-v5.6.2}"

# Test-optimized SCIP performance configuration
performance_config:
  # SCIP disabled for test simplicity and speed
  scip:
    enabled: false
    
  # Test-focused caching
  cache:
    enabled: true
    memory_limit: "384MB"
    ttl: "45m"
    
  # Test monitoring
  monitoring:
    enabled: true
    collect_detailed_metrics: false

# Logging configuration for test scenarios
logging:
  level: "info"
  enable_request_logging: true
  enable_performance_logging: true
  levels:
    typescript-language-server: "info"
    typescript-compiler: "info"
    test_runner: "debug"

# MCP-specific configuration
mcp:
  enabled: true
  tools:
    - "textDocument/definition"
    - "textDocument/references"
    - "textDocument/hover"
    - "textDocument/documentSymbol"
    - "workspace/symbol"
    - "textDocument/completion"
  
  # MCP transport settings
  transport:
    type: "stdio"
    timeout: "30s"
    
  # MCP protocol settings
  protocol:
    version: "2025-06-18"
    capabilities:
      tools: true
      resources: false
      prompts: false

# Test-specific settings
test_settings:
  # Timeout settings optimized for test scenarios
  timeouts:
    server_startup: "25s"
    lsp_request: "10s"
    definition: "8s"
    references: "10s"
    hover: "6s"
    completion: "10s"
    document_symbols: "8s"
    workspace_symbols: "10s"
    
  # Performance expectations for tests
  performance:
    max_response_time_ms: 10000
    max_memory_usage_mb: 768
    max_startup_time_ms: 25000
    
  # Test file patterns
  file_patterns:
    include:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.js"
      - "src/**/*.jsx"
      - "tests/**/*.ts"
      - "*.ts"
    exclude:
      - "node_modules/**"
      - "built/**"
      - "lib/**"
      - ".git/**"
      - "dist/**"
      - "coverage/**"
      
  # LSP method validation
  supported_methods:
    - "textDocument/definition"
    - "textDocument/references" 
    - "textDocument/hover"
    - "textDocument/completion"
    - "textDocument/documentSymbol"
    - "workspace/symbol"
    
  # Test data expectations
  test_expectations:
    min_ts_files: 5
    expected_directories:
      - "src"
      - "tests"
      - "lib"
    required_symbols:
      - "function"
      - "class"
      - "interface"
      - "type"
      - "enum"
      - "namespace"
      - "const"
      - "export"

# Integration with repository manager
repo_manager_integration:
  # Repository management settings
  repository:
    clone_timeout: "300s"
    checkout_timeout: "90s"
    validation_timeout: "45s"
    
  # Workspace management
  workspace:
    base_dir: "/tmp/lsp-gateway-typescript-e2e-tests"
    cleanup_on_exit: true
    preserve_on_error: false
    
  # File discovery settings
  file_discovery:
    source_dir: "src"
    recursive: true
    include_ts_files: true
    include_tsx_files: true
    include_js_files: true
    max_files: 500

# Error handling and recovery for tests
error_handling:
  # Test-appropriate error recovery
  recovery:
    max_retry_attempts: 3
    retry_delay: "3s"
    exponential_backoff: false
    
  # Error reporting for test diagnostics
  reporting:
    log_all_errors: true
    include_stack_traces: true
    error_context_size: 5
    
  # Bypass strategies for test stability
  bypass_strategies:
    server_failure: "fallback_server"
    timeout: "fail_fast"
    memory_limit: "restart_server"