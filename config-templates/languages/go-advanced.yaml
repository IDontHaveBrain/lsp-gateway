# Advanced Go Language Server Configuration
# Language: Go
# Framework: Multiple module support, build system integration
# Use Case: Large Go projects with multiple modules, high-performance requirements, microservices
# Prerequisites: gopls, go 1.19+, optional: golangci-lint, gofumpt
# Performance Notes: Optimized for large codebases with concurrent analysis and build integration

# Gateway configuration optimized for Go development
port: 8080
timeout: "45s"
max_concurrent_requests: 150
project_aware: true
enable_concurrent_servers: true
max_concurrent_servers_per_language: 4

# Multi-server configuration for Go workloads
multi_server_config:
  selection_strategy: "load_balance"
  concurrent_limit: 4
  resource_sharing: true
  health_check_interval: "25s"
  max_retries: 3

# Project context for Go applications
project_context:
  project_type: "multi-language"
  languages:
    - language: "go"
      frameworks: ["gin", "echo", "fiber", "grpc", "cobra"]
      file_patterns: ["*.go", "go.mod", "go.sum", "go.work"]
      root_markers: ["go.mod", "go.sum", "go.work"]

# Advanced Go language server pool with specialized instances
language_pools:
  - language: "go"
    default_server: "gopls-primary"
    servers:
      # Primary server with full analysis features
      gopls-primary:
        name: "gopls-primary"
        languages: ["go"]
        command: "gopls"
        transport: "stdio"
        priority: 3
        weight: 3.0
        max_concurrent_requests: 120
        root_markers: ["go.mod", "go.sum", "go.work"]
        
        # Advanced gopls settings for comprehensive analysis
        settings:
          gopls:
            # Code analysis features
            analyses:
              unusedparams: true
              shadow: true
              nilness: true
              unusedresult: true
              unreachable: true
              unusedwrite: true
              simplifycompositelit: true
              unusedvariable: true
              
            # Static analysis integration
            staticcheck: true
            
            # Code formatting
            gofumpt: true
            
            # Code lenses for enhanced IDE integration
            codelenses:
              gc_details: true
              generate: true
              test: true
              regenerate_cgo: true
              tidy: true
              upgrade_dependency: true
              vendor: true
              
            # Build system integration
            buildFlags: ["-tags=integration,e2e", "-race"]
            env:
              GOPROXY: "https://proxy.golang.org,direct"
              GOSUMDB: "sum.golang.org"
              GOFLAGS: "-mod=readonly"
              
            # Memory and performance optimization
            memoryMode: "Normal"
            experimentalWorkspaceModule: true
            allowModfileModifications: true
            
            # Advanced features
            semanticTokens: true
            linksInHover: true
            usePlaceholders: true
            completeFunctionCalls: true
            
            # Workspace settings for monorepos
            expandWorkspaceToModule: true
            experimentalUseInvalidMetadata: false
            
        # Resource limits for primary server
        environment:
          GOMAXPROCS: "4"
          GOMEMLIMIT: "2GiB"
          GODEBUG: "gctrace=0"
          
      # High-performance server for quick responses
      gopls-fast:
        name: "gopls-fast"
        languages: ["go"]
        command: "gopls"
        args: ["-rpc.trace"]
        transport: "stdio"
        priority: 2
        weight: 2.0
        max_concurrent_requests: 80
        root_markers: ["go.mod", "go.sum"]
        
        # Lightweight settings for fast responses
        settings:
          gopls:
            analyses:
              unusedparams: true
              shadow: false
              nilness: false
            staticcheck: false
            gofumpt: false
            codelenses:
              test: true
              generate: false
            buildFlags: []
            memoryMode: "DegradeClosed"
            semanticTokens: false
            
      # Testing-focused server instance
      gopls-test:
        name: "gopls-test"
        languages: ["go"]
        command: "gopls"
        args: ["-debug=localhost:6060"]
        transport: "stdio"
        priority: 2
        weight: 1.5
        max_concurrent_requests: 60
        root_markers: ["go.mod", "go.sum"]
        
        # Test-specific settings
        settings:
          gopls:
            analyses:
              unusedparams: true
              unusedresult: true
            buildFlags: ["-tags=test,integration", "-race"]
            codelenses:
              test: true
              generate: true
              regenerate_cgo: false
            env:
              CGO_ENABLED: "1"
              
      # Build and deployment focused server
      gopls-build:
        name: "gopls-build"
        languages: ["go"]
        command: "gopls"
        transport: "stdio"
        priority: 1
        weight: 1.0
        max_concurrent_requests: 40
        root_markers: ["go.mod", "go.sum", "Dockerfile", "Makefile"]
        
        # Build-optimized settings
        settings:
          gopls:
            analyses:
              unusedparams: false
              shadow: false
            buildFlags: ["-ldflags=-s -w", "-trimpath"]
            codelenses:
              generate: true
              tidy: true
              vendor: true
            env:
              CGO_ENABLED: "0"
              GOOS: "linux"
              GOARCH: "amd64"
              
    # Load balancing configuration
    load_balancing:
      strategy: "response_time"
      health_threshold: 0.85
      weight_factors:
        gopls-primary: 3.0
        gopls-fast: 2.0
        gopls-test: 1.5
        gopls-build: 1.0
        
    # Resource limits for Go pool
    resource_limits:
      max_memory_mb: 4096
      max_concurrent_requests: 300
      max_processes: 8
      request_timeout_seconds: 45

# Enhanced pool configuration for Go servers
servers:
  - name: "gopls-enhanced-pool"
    languages: ["go"]
    command: "gopls"
    transport: "stdio"
    root_markers: ["go.mod", "go.sum", "go.work"]
    
    # Enhanced pool configuration
    pool_config:
      min_size: 3
      max_size: 12
      warmup_size: 4
      
      # Dynamic scaling for Go workloads
      enable_dynamic_sizing: true
      target_utilization: 0.70
      scale_up_threshold: 0.80
      scale_down_threshold: 0.50
      
      # Connection lifecycle
      max_lifetime: 60m
      idle_timeout: 15m
      health_check_interval: 30s
      
      # Circuit breaker tuned for Go LSP
      max_retries: 5
      base_delay: 100ms
      circuit_timeout: 20s
      
      # Resource limits optimized for Go
      memory_limit_mb: 512
      cpu_limit_percent: 80.0
      
      transport_type: "stdio"
      custom_config:
        process_isolation: true
        buffer_management: "adaptive"
        stderr_logging: true
        
    # Health monitoring for Go servers
    health_check_settings:
      enabled: true
      interval: 25s
      timeout: 10s
      failure_threshold: 3
      success_threshold: 2
      method: "initialize"
      enable_auto_restart: true
      restart_delay: 5s
      max_consecutive_fails: 4
      
    # Go-specific environment
    environment:
      GOPRIVATE: "*.corp.example.com,rsc.io/private"
      GOPROXY: "https://proxy.golang.org,direct"
      GOSUMDB: "sum.golang.org"
      GOFLAGS: "-mod=readonly"
      GOMAXPROCS: "0"
      
# Smart routing configuration for Go methods
enable_smart_routing: true
enable_enhancements: true
smart_router_config:
  default_strategy: "single_target_with_fallback"
  method_strategies:
    "textDocument/definition": "single_target_with_fallback"
    "textDocument/references": "multi_target_parallel"
    "textDocument/documentSymbol": "primary_with_enhancement"
    "textDocument/hover": "primary_with_enhancement"
    "textDocument/completion": "single_target_with_fallback"
    "textDocument/codeAction": "multi_target_parallel"
    "textDocument/formatting": "single_target_with_fallback"
    "workspace/symbol": "broadcast_aggregate"
  enable_performance_monitoring: true
  enable_circuit_breaker: true
  circuit_breaker_threshold: 3
  circuit_breaker_timeout: "15s"

# Framework-specific optimizations
optimizations:
  go:
    # Build system integration
    build_tools:
      - name: "go_modules"
        enabled: true
        settings:
          auto_tidy: true
          vendor_support: true
          replace_directives: true
          
      - name: "make_integration"
        enabled: true
        settings:
          auto_detect_targets: true
          parallel_builds: true
          
      - name: "docker_integration"
        enabled: true
        settings:
          multistage_builds: true
          alpine_support: true
          
    # Code quality tools
    linting:
      - name: "golangci-lint"
        enabled: true
        config_file: ".golangci.yml"
        settings:
          fast: false
          enable_all: false
          presets: ["bugs", "performance", "unused"]
          
    # Testing frameworks
    testing:
      - name: "go_test"
        enabled: true
        settings:
          race_detection: true
          coverage: true
          benchmarks: true
          
      - name: "testify"
        enabled: true
        settings:
          suite_support: true
          mock_generation: true
          
    # Performance monitoring
    profiling:
      - name: "pprof"
        enabled: true
        settings:
          cpu_profiling: true
          memory_profiling: true
          block_profiling: true
          
    # Microservices support
    frameworks:
      gin:
        enabled: true
        settings:
          route_detection: true
          middleware_analysis: true
          
      grpc:
        enabled: true
        settings:
          proto_support: true
          service_discovery: true
          
      cobra:
        enabled: true
        settings:
          command_completion: true
          flag_analysis: true

# Development workflow integration
workflow_integration:
  # Version control
  git:
    hooks:
      pre_commit:
        - "go fmt ./..."
        - "go vet ./..."
        - "golangci-lint run"
        
  # Editor integration
  vscode:
    settings:
      "go.useLanguageServer": true
      "go.languageServerFlags": ["-rpc.trace"]
      "go.lintOnSave": "package"
      "go.buildOnSave": "workspace"

# Go-Optimized SCIP Performance Configuration  
# SCIP indexing specifically tuned for advanced Go development with
# multiple modules, microservices, and high-concurrency applications
performance_config:
  # Go-Focused SCIP Configuration - Advanced Development
  scip:
    # Core SCIP settings optimized for Go
    enabled: true
    
    # Go-specific index storage with module-aware organization
    index_path: "/opt/lspg/go-scip-indices"
    
    # Frequent refresh for active Go development
    auto_refresh: true  
    refresh_interval: "20m"  # Balanced for Go compilation speed
    
    # Reliable fallback to gopls when needed
    fallback_to_lsp: true
    fallback_timeout: "8s"
    
    # Go-optimized caching with module-aware partitioning
    cache:
      enabled: true
      ttl: "90m"  # Longer TTL for stable Go builds
      max_size: 3000  # Good size for Go codebases
      enable_module_partitioning: true
      cache_by_go_version: true
      
    # Advanced Go language settings
    language_settings:
      go:
        enabled: true
        
        # Multiple indexing strategies for different Go server tiers
        indexing_strategies:
          # Primary comprehensive indexing
          primary:
            index_command: ["scip-go", "--comprehensive", "--enable-generics"]
            index_timeout: "12m"
            index_concurrency: 6
            enable_cross_module_analysis: true
            enable_vendor_analysis: true
            enable_test_analysis: true
            build_flags: ["-tags=integration,e2e", "-race"]
            
          # Fast indexing for quick responses  
          fast:
            index_command: ["scip-go", "--fast", "--skip-tests"]
            index_timeout: "5m"
            index_concurrency: 4
            enable_cross_module_analysis: false
            enable_vendor_analysis: false
            build_flags: []
            
          # Testing-focused indexing
          test:
            index_command: ["scip-go", "--test-focused"]
            index_timeout: "8m"
            index_concurrency: 3
            enable_benchmark_analysis: true
            enable_fuzz_test_analysis: true
            build_flags: ["-tags=test,integration", "-race"]
            
          # Build-optimized indexing
          build:
            index_command: ["scip-go", "--build-optimized"]
            index_timeout: "6m"
            index_concurrency: 2
            enable_build_constraint_analysis: true
            enable_cross_compilation_analysis: true
            build_flags: ["-ldflags=-s -w", "-trimpath"]
            
        # Go-specific advanced features
        advanced_features:
          # Module and workspace analysis
          modules:
            enable_go_work_support: true
            enable_replace_directive_analysis: true
            enable_vendor_analysis: true
            enable_module_dependency_graph: true
            
          # Code generation and tooling
          codegen:
            enable_generate_analysis: true
            enable_embed_analysis: true
            enable_build_tag_analysis: true
            enable_cgo_analysis: true
            
          # Performance and profiling
          performance:
            enable_pprof_integration: true
            enable_benchmark_analysis: true
            enable_memory_profiling_hints: true
            enable_goroutine_analysis: true
            
          # Framework-specific analysis
          frameworks:
            gin:
              enable_route_analysis: true
              enable_middleware_chain_analysis: true
              enable_handler_signature_analysis: true
              
            grpc:
              enable_proto_analysis: true
              enable_service_definition_analysis: true
              enable_interceptor_analysis: true
              
            cobra:
              enable_command_tree_analysis: true
              enable_flag_analysis: true
              enable_completion_analysis: true
              
            echo:
              enable_route_analysis: true
              enable_middleware_analysis: true
              
            fiber:
              enable_route_analysis: true
              enable_hook_analysis: true
              
        # Go build system integration
        build_integration:
          # Go modules support
          go_modules:
            enable_go_mod_analysis: true
            enable_go_sum_verification: true
            enable_go_work_analysis: true
            
          # Make integration
          make:
            enable_makefile_analysis: true
            enable_target_dependency_analysis: true
            
          # Docker integration  
          docker:
            enable_dockerfile_analysis: true
            enable_multistage_analysis: true
            enable_go_alpine_optimizations: true
            
        # Environment-specific configurations
        environments:
          development:
            enable_race_detection: true
            enable_debug_symbols: true
            optimize_for_compilation_speed: true
            
          production:
            enable_optimization_analysis: true
            enable_binary_size_analysis: true
            enable_cross_compilation_support: true
            
          testing:
            enable_test_coverage_analysis: true
            enable_benchmark_regression_detection: true
            enable_fuzz_test_support: true
            
    # Go-specific monitoring and diagnostics
    monitoring:
      enabled: true
      
      # Go build and compilation metrics
      build_metrics:
        track_compilation_time: true
        track_module_resolution_time: true
        track_vendor_analysis_time: true
        track_test_discovery_time: true
        
      # Go runtime metrics
      runtime_metrics:
        track_goroutine_analysis: true
        track_gc_analysis: true
        track_memory_allocation_patterns: true
        
      # Go toolchain integration
      toolchain_metrics:
        track_gofmt_performance: true
        track_golint_integration: true
        track_go_vet_analysis: true
        track_staticcheck_performance: true
        
    # Intelligent Go query routing
    smart_routing:
      enabled: true
      
      # Go-specific routing strategies
      routing_strategies:
        # Route based on Go server specialization
        server_specialization:
          primary_queries: ["definition", "references", "hover"]
          fast_queries: ["completion", "formatting"]
          test_queries: ["test_discovery", "benchmark_analysis"]
          build_queries: ["build_analysis", "cross_compilation"]
          
        # Route based on Go module boundaries
        module_awareness:
          intra_module_queries: "primary_server"
          cross_module_queries: "comprehensive_server"
          vendor_queries: "specialized_server"
          
    # Go development workflow integration
    workflow_integration:
      # Version control hooks
      git_hooks:
        pre_commit:
          - "go fmt ./..."
          - "go vet ./..."
          - "golangci-lint run"
          - "go mod tidy"
          
      # IDE integration
      ide_features:
        enable_code_lens_integration: true
        enable_inlay_hints: true
        enable_semantic_tokens: true
        enable_call_hierarchy: true
        
      # CI/CD integration
      ci_cd:
        enable_build_cache_analysis: true
        enable_test_cache_optimization: true
        enable_binary_size_tracking: true

# Logging configuration
logging:
  go_servers: true
  build_integration: true
  performance_metrics: true
  scip_indexing: true  # Add SCIP-specific logging
  levels:
    gopls: "info"
    build_tools: "warn"
    linting: "info"
    testing: "debug"
    scip_go: "info"  # SCIP indexer logging

# Migration guide from basic configuration
migration:
  from_basic:
    steps:
      - "Update go.mod to Go 1.19+"
      - "Install golangci-lint and gofumpt"
      - "Configure build tags and GOPROXY"
      - "Set up workspace for monorepos"
      - "Enable advanced gopls features"
    breaking_changes:
      - "Requires gopls v0.11.0+"
      - "Some analysis settings require Go 1.19+"
      - "Workspace mode changes project detection"